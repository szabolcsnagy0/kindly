name: Claude Review

on:
  issue_comment:
    types: [created]

run-name: ${{ github.workflow }}--${{ github.event.issue.number }}

env:
  GITHUB_PR_NUMBER: ${{ github.event.issue.number }}

concurrency:
  group: claude-review-${{ github.event.issue.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: write

jobs:
  claude-review:
    # Trigger only on PR comments starting with 'claude-review'
    if: ${{ github.event.issue.pull_request && startsWith(github.event.comment.body, 'claude-review') }}
    runs-on: ubuntu-latest

    steps:
      - name: React to Trigger Comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            })

      - name: Checkout PR Code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ env.GITHUB_PR_NUMBER }}/head
          fetch-depth: 0

      - name: Create Claude Check Run
        id: create-check
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const check = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: "Claude Review",
              head_sha: pr.data.head.sha,
              status: "in_progress",
              output: {
                title: "Claude Review",
                summary: "Review in progress‚Ä¶"
              }
            });

            core.setOutput("check_run_id", check.data.id);

      - name: Post Start Comment
        id: initial-comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ env.GITHUB_PR_NUMBER }}
          body: |
            ## üïµÔ∏è‚Äç‚ôÇÔ∏è Claude Review

            Review started‚Ä¶
            [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Get PR Details
        id: get-pr-details
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('base_branch', pr.data.base.ref);
            core.setOutput('head_sha', pr.data.head.sha);

      - name: Fetch Base Branch
        run: git fetch origin ${{ steps.get-pr-details.outputs.base_branch }}

      - name: Run Claude Review
        id: review
        continue-on-error: true
        timeout-minutes: 15
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CI: true
        run: |
          claude --print "$(envsubst < .github/claude-review-prompt.md)" > review_report.md

      - name: Extract Report Content
        run: |
          python3 - <<'EOF'
          import re, sys, json

          content = open("review_report.md").read()
          match = re.search(r"<review_report>(.*?)</review_report>", content, re.S)
          if not match:
              print("NO_REPORT=true", file=open(os.environ["GITHUB_ENV"], "a"))
              sys.exit(0)

          body = match.group(1).strip()
          open("clean_report.md", "w").write(body)
          EOF

      - name: Generate Check Run Annotations
        id: annotations
        run: |
          python3 - <<'EOF'
          import re, json

          annotations = []

          table = open("clean_report.md").read()
          rows = [r for r in table.splitlines() if r.startswith("|")][2:]

          for row in rows:
              cols = [c.strip() for c in row.strip("|").split("|")]
              if len(cols) < 6:
                  continue

              severity, issue, location = cols[1], cols[3], cols[5]

              if ":" not in location:
                  continue

              path, line = location.split(":")
              annotations.append({
                  "path": path,
                  "start_line": int(line),
                  "end_line": int(line),
                  "annotation_level": "failure",
                  "message": issue
              })

          open("annotations.json", "w").write(json.dumps(annotations))
          print(f"Generated {len(annotations)} annotations")
          EOF

      - name: Complete Check Run
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const annotations = fs.existsSync("annotations.json")
              ? JSON.parse(fs.readFileSync("annotations.json", "utf8"))
              : [];

            const conclusion =
              "${{ steps.review.outcome }}" === "success" && annotations.length === 0
                ? "success"
                : "failure";

            await github.rest.checks.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              check_run_id: Number("${{ steps.create-check.outputs.check_run_id }}"),
              status: "completed",
              conclusion,
              output: {
                title: "Claude Review",
                summary:
                  annotations.length === 0
                    ? "No issues found."
                    : `${annotations.length} issue(s) found.`,
                annotations: annotations.slice(0, 50)
              }
            });

      - name: Post Final Comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.initial-comment.outputs.comment-id }}
          issue-number: ${{ env.GITHUB_PR_NUMBER }}
          body-path: clean_report.md
          edit-mode: replace
