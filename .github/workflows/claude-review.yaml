name: Claude Review

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write

jobs:
  sdet-audit:
    # Trigger only on PR comments starting with '/claude-review'
    if: ${{ github.event.issue.pull_request && startsWith(github.event.comment.body, '/claude-review') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR Code
        uses: actions/checkout@v4
        with:
          # Checkout the head of the PR branch
          ref: refs/pull/${{ github.event.issue.number }}/head
          # Fetch full history (depth: 0) so the agent can compare against main
          fetch-depth: 0

      - name: Fetch Main Branch
        run: git fetch origin main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Create Audit Instructions
        run: |
          cat << 'EOF' > audit_instructions.md
          # Role: Senior SDET & Code Auditor

          **Objective:** Audit the provided Git Diff for Security, Robustness, Test Coverage, and Code Quality.
          **Prime Directive:** Minimize False Positives. If the code is well-tested, secure, and clean, strictly output "âœ… No issues found."

          ## Phase 1: Context Gathering

          **CRITICAL RULE:** All `git` commands MUST use the `--no-pager` flag. Never run a git command that might trigger an interactive shell.

          1.  **Identify Changes:**
              Execute: `git --no-pager diff --name-only origin/main...HEAD | grep -vE 'package-lock.json|yarn.lock|dist/|\.map$'`

          2.  **Map & Read:**
              For every logic file modified:
              a. Locate its corresponding test file.
              b. Use `read_file` to read the **FULL content** of both source and test files.

          3.  **Isolate the Delta:**
              Execute: `git --no-pager diff origin/main...HEAD -- [list of source files]`
              *Use this diff to pinpoint exactly which lines are new.*

          ## Phase 2: The Audit
          *Internal process only. Do not output text during this phase.*

          1.  **Security Scan (CRITICAL):**
              * **Secrets:** Scan added lines for hardcoded API keys, tokens, or passwords.
              * **Injection:** Check for unsanitized inputs in SQL, shell commands, or HTML.
              * **Input Validation:** Ensure external inputs (API payloads, DB results) are typed/validated before use.

          2.  **Correctness & Robustness:**
              * **Error Handling:** Look for "swallowed" errors (Promises without `.catch`, empty `try/catch` blocks).
              * **Edge Cases:** Does the logic handle `null`, `undefined`, or empty arrays?
              * **Async Safety:** Check for potential race conditions or un-awaited Promises.

          3.  **The Coverage & Quality Check:**
              * **Gap Analysis:** Do the changes include **Negative Test Cases** (error paths/invalid inputs), not just happy paths?
              * **Strictness:** Flag `expect.any(...)` or loose matchers unless strictly necessary for non-deterministic data.
              * **Cleanliness:** Flag Magic Numbers, deeply nested complexity, or debug artifacts (`console.log`).

          ## Phase 3: The Output (Strict Conditional)

          **CRITICAL:** Output Markdown directly. No conversational filler.

          **Evaluation Logic:**
          IF (No Security Issues AND No Critical Logic Gaps AND No Weak Assertions AND No Quality issues):
              Output **Scenario A**.
          ELSE:
              Output **Scenario B**.

          ---

          ### Scenario A: Clean Bill of Health
          ## Code Audit: PASS
          **Verified:** [One concise sentence. Example: "Update to `AuthService` handles edge cases correctly and includes strict negative testing."]

          ---

          ### Scenario B: Issues Found
          ## Code & Security Audit

          ### Actionable Items
          *List all security risks, bugs, coverage gaps, or weak assertions.*

          - **[Category] [File/Test Name]:** [Brief description]
            *Example: "**[Security] `db_client.ts`:** Potential SQL injection; input parameter is concatenated directly."*
            *Example: "**[Reliability] `api_handler.ts`:** Promise rejection is unhandled in `fetchUserData`."*
            *Example: "**[Coverage] `auth_flow.ts`:** Logic handles invalid tokens, but no corresponding negative test exists in `auth_flow.test.ts`."*
            *Example: "**[Quality] `calculator.ts`:** Magic number `86400` used; extract to `SECONDS_IN_DAY` constant."*
          EOF

      - name: Run Claude Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CI: true
        run: |
          # We pipe the prompt into Claude.
          # The --print flag ensures it outputs the response to stdout.
          claude --print "$(cat audit_instructions.md)" > sdet_report.md

      - name: Post Audit Comment
        uses: thollander/actions-comment-pull-request@v2
        with:
          filePath: sdet_report.md
          comment_tag: sdet_audit_report
