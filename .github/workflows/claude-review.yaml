name: Claude Review

on:
  issue_comment:
    types: [created]

run-name: ${{ github.workflow }}--${{ github.event.issue.number }}

env:
  GITHUB_PR_NUMBER: ${{ github.event.issue.number }}

concurrency:
  group: claude-review-${{ github.event.issue.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-review:
    # Trigger only on PR comments starting with '/claude-review'
    if: ${{ github.event.issue.pull_request && startsWith(github.event.comment.body, '/claude-review') }}
    runs-on: ubuntu-latest

    steps:
      - name: React to Trigger Comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            })

      - name: Checkout PR Code
        uses: actions/checkout@v4
        with:
          # Checkout the head of the PR branch
          ref: refs/pull/${{ env.GITHUB_PR_NUMBER }}/head
          # Fetch full history (depth: 0) so the agent can compare against main
          fetch-depth: 0

      - name: Post Start Comment
        id: initial-comment
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # 4.0.0
        with:
          issue-number: ${{ env.GITHUB_PR_NUMBER }}
          body: |
            Review started... I am analyzing your changes. üïµÔ∏è‚Äç‚ôÇÔ∏è

            [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Fetch Main Branch
        run: git fetch origin main

      - name: Validate PR Has Changes
        run: |
          CHANGES=$(git --no-pager diff --name-only origin/main...HEAD | wc -l)
          if [ "$CHANGES" -eq 0 ]; then
            echo "No changes detected in this PR"
            exit 1
          fi
          echo "Found $CHANGES changed files"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Create Audit Instructions
        run: |
          cat << 'EOF' > audit_instructions.md
          # Role: Senior Engineering Architect & Code Auditor

          **Objective:** Perform an exhaustive, professional code review of this Pull Request against main branch.

          **Prime Directive:** Be thorough but precise. Flag real issues with clear justification. If code is production-ready, say so clearly.

          ## Phase 1: Comprehensive Context Gathering

          **CRITICAL:** All git commands MUST use `--no-pager`. Never trigger interactive shells.

          1. **Get Complete Diff:**
             ```bash
             git --no-pager diff origin/main...HEAD
             ```

          2. **Identify All Changed Files:**
             ```bash
             git --no-pager diff --name-status origin/main...HEAD
             ```

          3. **Read Full Context:**
             - For each modified file, use Read tool to get COMPLETE file contents
             - For each new file, understand its purpose in the broader architecture
             - Identify corresponding test files and read them fully
             - Look for related files that might be affected (imports, dependencies)

          4. **Understand the Change:**
             - What problem is being solved?
             - What is the scope of impact?
             - Are there related changes that should have been included?

          ## Phase 2: Multi-Dimensional Analysis

          Evaluate the changes across ALL dimensions below. Think critically about each.

          **Security (BLOCKING)**
          - Secrets & Credentials: Any hardcoded API keys, tokens, passwords, or sensitive data?
          - Injection Vulnerabilities: SQL injection, command injection, XSS, path traversal?
          - Input Validation: Are all external inputs (API payloads, user input, file uploads) validated?
          - Authentication & Authorization: Are security boundaries properly enforced?
          - Dependency Security: Any new dependencies with known vulnerabilities?

          **Architecture & Scaling**
          - Scalability: Will this work at 10x, 100x current load?
          - Database Performance: Are there N+1 queries, missing indexes, or table scans?
          - Memory & Resource Usage: Any memory leaks, unbounded collections, or resource exhaustion risks?
          - Architectural Consistency: Does this fit the existing system design patterns?
          - Service Boundaries: Are responsibilities properly separated?

          **Correctness & Robustness**
          - Error Handling: Are all error paths handled? Any swallowed errors?
          - Edge Cases: Null, undefined, empty arrays, boundary conditions, race conditions?
          - Async Safety: All Promises awaited? Proper async/await usage?
          - Data Integrity: Can this cause data corruption or inconsistency?
          - Concurrency: Thread-safe? Handles concurrent requests properly?

          **Consistency & Maintainability**
          - Code Style: Consistent with the existing codebase patterns?
          - Naming: Clear, descriptive, following project conventions?
          - Complexity: Is the solution as simple as it can be, or over-engineered?
          - Duplication: Is there existing code that does something similar?
          - Magic Numbers/Strings: Are constants properly named and documented?
          - Technical Debt: Does this add debt, or reduce it?

          **Failure Modes & Graceful Degradation**
          - Failure Impact: What happens when this code fails? Does it cascade?
          - Graceful Degradation: Can the system continue operating in a degraded state?
          - Rollback Safety: Can this change be safely rolled back?
          - Monitoring & Observability: Can failures be detected and diagnosed?
          - Retry Logic: Appropriate backoff and retry strategies?

          **Trap-Door Decisions**
          - Irreversible Choices: Are there decisions that will be hard to change later?
          - API Contracts: Are new APIs well-designed? Versioned if public?
          - Database Migrations: Are schema changes backwards compatible?
          - Breaking Changes: Any breaking changes to existing contracts?

          **Testing & Coverage**
          - Test Coverage: Are all new code paths tested?
          - Negative Tests: Are error paths and edge cases tested?
          - Integration Tests: Are interactions with other systems tested?
          - Test Quality: Are assertions specific and meaningful (not .any())?
          - Flakiness Risk: Are tests deterministic and reliable?

          **Complexity & Code Quality**
          - Cyclomatic Complexity: Is the code easy to understand?
          - Nesting Depth: Too many nested conditionals or callbacks?
          - Function Length: Are functions focused and reasonably sized?
          - Debug Artifacts: Any console.log, debugger, or commented code?
          - Documentation: Are complex algorithms or business logic explained?

          ## Phase 3: Structured Output

          **Format:** Use clear, professional markdown. Be direct and specific.

          ### If No Significant Issues Found

          ```markdown
          ## Code Review: APPROVED ‚úÖ

          **Summary:** [2-3 sentences describing what changed and confirming it's production-ready]

          **Verified:**
          - Security: No vulnerabilities detected
          - Architecture: Aligns with existing patterns
          - Testing: Adequate coverage including edge cases
          - Quality: Clean, maintainable code

          **Notes:** [Any minor observations or suggestions for future consideration]
          ```

          ### If Issues Found

          ```markdown
          ## Code Review: CHANGES REQUESTED

          ### Issues Found

          1. **[Security] file.ts:45:** [Clear description of issue]
             - **Impact:** [Why this matters]
             - **Suggestion:** [How to fix]

          2. **[Performance] api.ts:120:** [Description]
             - **Impact:** [Risk/concern]
             - **Suggestion:** [Recommended fix]

          3. **[Quality] utils.ts:34:** [Description]
             - **Suggestion:** [How to improve]

          ### Summary
          [Overall assessment - how many critical vs minor issues, overall recommendation]
          ```

          ## Guidelines for Output

          - **Be specific:** Reference exact files and line numbers
          - **Explain impact:** Don't just say "this is bad", explain why it matters
          - **Provide solutions:** Suggest concrete fixes
          - **Be honest:** If the code is good, say so. If it's not, explain clearly.
          - **Think holistically:** Consider the entire system, not just the diff
          - **Use numbered lists:** Makes issues easy to reference and discuss
          EOF

      - name: Run Claude Review
        id: review
        continue-on-error: true
        timeout-minutes: 10
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CI: true
        run: |
          claude --print "$(cat audit_instructions.md)" > review_report.md

      - name: Post Success Comment
        if: ${{ steps.review.outcome == 'success' }}
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # 4.0.0
        with:
          comment-id: ${{ steps.initial-comment.outputs.comment-id }}
          issue-number: ${{ env.GITHUB_PR_NUMBER }}
          body-path: review_report.md
          edit-mode: replace

      - name: Post Failure Comment
        if: ${{ steps.review.outcome == 'failure' }}
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # 4.0.0
        with:
          comment-id: ${{ steps.initial-comment.outputs.comment-id }}
          issue-number: ${{ env.GITHUB_PR_NUMBER }}
          body: |
            :x: Claude review failed to complete.

            [View workflow run for details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          edit-mode: replace
