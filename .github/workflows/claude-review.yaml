name: Claude Review

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR Number to review'
        required: true
        type: string

run-name: ${{ github.workflow }}--${{ github.event.issue.number || inputs.pr_number }}

env:
  GITHUB_PR_NUMBER: ${{ github.event.issue.number || inputs.pr_number }}

concurrency:
  group: claude-review-${{ github.event.issue.number || inputs.pr_number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-review:
    # Trigger on PR comments starting with 'claude-review' OR manual workflow dispatch
    if: ${{ (github.event.issue.pull_request && startsWith(github.event.comment.body, 'claude-review')) || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
      - name: React to Trigger Comment
        if: ${{ github.event_name == 'issue_comment' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            })

      - name: Checkout PR Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: refs/pull/${{ env.GITHUB_PR_NUMBER }}/head
          fetch-depth: 0
          filter: blob:none

      - name: Post Running Comment
        id: running-comment
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
        with:
          issue-number: ${{ env.GITHUB_PR_NUMBER }}
          body: |
            ## ⏳ Claude Review Running

            Review started... I am analyzing your changes. [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Get PR Details
        id: get-pr-details
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: process.env.GITHUB_PR_NUMBER
            });
            core.setOutput('base_branch', pr.data.base.ref);
            core.setOutput('head_sha', pr.data.head.sha);
            return pr.data.base.ref;

      - name: Fetch Base Branch
        run: git fetch origin ${{ steps.get-pr-details.outputs.base_branch }}

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'

      - name: Install Dependencies
        run: |
          # Ensure ripgrep is installed
          command -v rg >/dev/null 2>&1 || sudo apt-get update && sudo apt-get install -y ripgrep

      - name: Get Previous Review State
        id: get-state
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const { main } = await import('${{ github.workspace }}/.github/scripts/claude-review/get-previous-state.js');
            const { state, previous_sha } = await main(github, context);

            // Save state to file
            const fs = require('fs');
            fs.writeFileSync('state.json', JSON.stringify(state, null, 2));
            console.log(`Wrote state with ${state.issues.length} issues`);

            // Set output for next steps
            core.setOutput('previous_sha', previous_sha);

      - name: Extract Custom Instructions
        id: extract-instructions
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const commentBody = context.payload?.comment?.body ?? '';
            const match = commentBody.match(/^claude-review\s+(.+)$/s);
            const customInstructions = match?.[1]?.trim() ?? '';

            core.exportVariable('CUSTOM_INSTRUCTIONS', customInstructions);
            console.log(customInstructions
              ? `Custom instructions: ${customInstructions}`
              : 'No custom instructions provided');

      - name: Detect Ignore Commands
        continue-on-error: true
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const { main } = await import('${{ github.workspace }}/.github/scripts/claude-review/detect-ignore-commands.js');
            await main(github, context);

      - name: Prepare Review Context
        id: prepare-context
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const { main } = await import('${{ github.workspace }}/.github/scripts/claude-review/prepare-review-context.js');
            const reviewContext = await main();
            core.exportVariable('PREVIOUS_REVIEW_CONTEXT', reviewContext);

      - name: Determine Review Mode & Diff Base
        id: determine-mode
        run: |
          PREV_SHA="${{ steps.get-state.outputs.previous_sha }}"
          BASE_REF="origin/${{ steps.get-pr-details.outputs.base_branch }}"

          # Check if PREV_SHA is valid and exists in the current history (wasn't force-pushed away)
          if [ -n "$PREV_SHA" ] && git cat-file -t "$PREV_SHA" > /dev/null 2>&1; then
            echo "Review Mode: INCREMENTAL"
            echo "REVIEW_MODE=INCREMENTAL" >> $GITHUB_ENV
            echo "DIFF_BASE=$PREV_SHA" >> $GITHUB_ENV
          else
            echo "Review Mode: FULL"
            echo "REVIEW_MODE=FULL" >> $GITHUB_ENV
            echo "DIFF_BASE=$BASE_REF" >> $GITHUB_ENV
          fi

      - name: Validate Changes
        id: validate
        run: |
          CHANGES=$(git --no-pager diff --name-only ${{ env.DIFF_BASE }}...HEAD | wc -l)
          if [ "$CHANGES" -eq 0 ]; then
            echo "No changes detected against ${{ env.DIFF_BASE }}"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Found $CHANGES changed files."
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Prepare Changed Files
        if: ${{ steps.validate.outputs.has_changes == 'true' }}
        run: |
          mkdir -p changed_files

          git --no-pager diff --name-only ${{ env.DIFF_BASE }}...HEAD | while IFS= read -r file; do
            if [ -f "$file" ]; then
              target_dir="changed_files/$(dirname "$file")"
              mkdir -p "$target_dir"
              cp "$file" "changed_files/$file"
            fi
          done

          # Generate unified diff showing all changes
          git --no-pager diff ${{ env.DIFF_BASE }}...HEAD > unified_diff.txt

          FILE_COUNT=$(git --no-pager diff --name-only ${{ env.DIFF_BASE }}...HEAD | wc -l)
          echo "Prepared $FILE_COUNT changed files for review"

      - name: Validate API Key
        if: ${{ steps.validate.outputs.has_changes == 'true' }}
        run: |
          if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ]; then
            echo "ERROR: ANTHROPIC_API_KEY secret is not set"
            exit 1
          fi

      - name: Install Claude Code
        if: ${{ steps.validate.outputs.has_changes == 'true' }}
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Claude Review
        id: review
        if: ${{ steps.validate.outputs.has_changes == 'true' }}
        continue-on-error: true
        timeout-minutes: 15
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CI: true
          # REVIEW_MODE, DIFF_BASE, PREVIOUS_REVIEW_CONTEXT, CUSTOM_INSTRUCTIONS are already in env
        run: |
          claude --print "$(envsubst < .github/claude-review-prompt.md)" > review_output.txt
          cat review_output.txt

      - name: Process Review
        if: ${{ steps.review.outcome == 'success' }}
        run: node .github/scripts/claude-review/process-review.js
        env:
          HEAD_SHA: ${{ steps.get-pr-details.outputs.head_sha }}
          REVIEW_MODE: ${{ env.REVIEW_MODE }}

      - name: Create Inline Comments
        if: ${{ steps.review.outcome == 'success' }}
        continue-on-error: true
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const { main } = await import('${{ github.workspace }}/.github/scripts/claude-review/create-inline-comments.js');
            await main(github, context, '${{ steps.get-pr-details.outputs.head_sha }}');

      - name: Encode State
        if: ${{ steps.validate.outputs.has_changes == 'false' || steps.review.outcome == 'success' }}
        run: node .github/scripts/claude-review/encode-state.js

      - name: Generate Summary
        if: ${{ steps.validate.outputs.has_changes == 'false' || steps.review.outcome == 'success' }}
        run: node .github/scripts/claude-review/generate-summary.js
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_PR_NUMBER: ${{ env.GITHUB_PR_NUMBER }}

      - name: Update Comments
        if: ${{ steps.validate.outputs.has_changes == 'false' || steps.review.outcome == 'success' }}
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const { main } = await import('${{ github.workspace }}/.github/scripts/claude-review/update-comments.js');
            const runningCommentId = '${{ steps.running-comment.outputs.comment-id }}';
            const runId = '${{ github.run_id }}';
            const hasChanges = '${{ steps.validate.outputs.has_changes }}' === 'true';
            await main(github, context, runningCommentId, runId, hasChanges);

      - name: Update Running Comment - Failure
        if: ${{ failure() && steps.running-comment.outputs.comment-id }}
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
        with:
          comment-id: ${{ steps.running-comment.outputs.comment-id }}
          issue-number: ${{ env.GITHUB_PR_NUMBER }}
          body: |
            ## ❌ Claude Review Failed

            The review failed to complete. Please check the workflow run for details.

            [View workflow run for details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          edit-mode: replace
