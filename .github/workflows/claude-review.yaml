name: Claude Review

on:
  issue_comment:
    types: [created]

run-name: ${{ github.workflow }}--${{ github.event.issue.number }}

env:
  GITHUB_PR_NUMBER: ${{ github.event.issue.number }}

concurrency:
  group: claude-review-${{ github.event.issue.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-review:
    # Trigger only on PR comments starting with '/claude-review'
    if: ${{ github.event.issue.pull_request && startsWith(github.event.comment.body, '/claude-review') }}
    runs-on: ubuntu-latest

    steps:
      - name: React to Trigger Comment
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            })

      - name: Checkout PR Code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ env.GITHUB_PR_NUMBER }}/head
          fetch-depth: 0

      - name: Post Start Comment
        id: initial-comment
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043
        with:
          issue-number: ${{ env.GITHUB_PR_NUMBER }}
          body: |
            Review started... I am analyzing your changes. üïµÔ∏è‚Äç‚ôÇÔ∏è

            [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Get PR Base Branch
        id: get-base
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('base_branch', pr.data.base.ref);
            return pr.data.base.ref;

      - name: Fetch Base Branch
        run: git fetch origin ${{ steps.get-base.outputs.base_branch }}

      - name: Validate PR Has Changes
        run: |
          BASE_BRANCH="origin/${{ steps.get-base.outputs.base_branch }}"
          CHANGES=$(git --no-pager diff --name-only ${BASE_BRANCH}...HEAD | wc -l)
          if [ "$CHANGES" -eq 0 ]; then
            echo "No changes detected in this PR"
            exit 1
          fi
          echo "Found $CHANGES changed files against base branch: ${{ steps.get-base.outputs.base_branch }}"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Claude Review
        id: review
        continue-on-error: true
        timeout-minutes: 10
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          BASE_BRANCH: ${{ steps.get-base.outputs.base_branch }}
          CI: true
        run: |
          claude --print "$(envsubst < .github/claude-review-prompt.md)" > review_report.md

      - name: Post Success Comment
        if: ${{ steps.review.outcome == 'success' }}
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # 4.0.0
        with:
          comment-id: ${{ steps.initial-comment.outputs.comment-id }}
          issue-number: ${{ env.GITHUB_PR_NUMBER }}
          body-path: review_report.md
          edit-mode: replace

      - name: Post Failure Comment
        if: ${{ steps.review.outcome == 'failure' }}
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # 4.0.0
        with:
          comment-id: ${{ steps.initial-comment.outputs.comment-id }}
          issue-number: ${{ env.GITHUB_PR_NUMBER }}
          body: |
            :x: Claude review failed to complete.

            [View workflow run for details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          edit-mode: replace
